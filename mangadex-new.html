<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mangadex — Новинки</title>
  <link rel="stylesheet" href="/css/main.css" />
  <style>
    /* Light theme and tidy layout */
    body { padding:18px; font-family: system-ui,Segoe UI,Roboto,Arial; background:#fff; color:#111 }
    h1 { margin-bottom:12px }
    .panel { background:#fff; border:1px solid #eee; padding:12px; border-radius:8px; display:flex; gap:12px; align-items:center }
    .controls { display:flex; gap:12px; align-items:center }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:14px; margin-top:12px }
    .card { border:1px solid #e9e9e9; padding:10px; border-radius:6px; background:#fff; display:flex; gap:10px }
    .thumb { width:100px; height:150px; background:#f6f6f6; flex:0 0 100px; object-fit:cover }
    .meta { flex:1; display:flex; flex-direction:column }
    .title { font-weight:700; margin-bottom:6px }
    .subtitle { color:#666; font-size:13px; margin-bottom:8px }
    .tags { margin-top:auto; display:flex; flex-wrap:wrap; gap:6px }
    .tag { background:#f3f3f3; padding:4px 6px; border-radius:4px; font-size:12px }
    .desc { font-size:13px; color:#333; max-height:72px; overflow:hidden }
    input { padding:8px; border:1px solid #ddd; border-radius:4px }
    .btn { padding:8px 12px; border-radius:6px; border:1px solid #bbb; background:#fafafa; cursor:pointer }
  </style>
</head>
<body>
  <header class="panel" style="display:flex; align-items:center; gap:10px; margin-bottom:14px">
    <nav aria-label="Main">
      <a class="btn" href="/mangadex-test.html">Tester</a>
      <a class="btn" href="/mangadex-search.html">Search</a>
      <a class="btn" href="/mangadex-new.html">New</a>
      <a class="btn" href="/mangadex-popular.html">Popular</a>
    </nav>
  </header>

  <h1>Новинки</h1>
  <div class="panel" style="margin-bottom:10px;">
    <button id="prev" class="btn">‹ Prev</button>
    <div>Страница <strong id="pageDisplay">1</strong></div>
    <button id="next" class="btn">Next ›</button>
    <label style="margin-left:auto">Limit <input id="limitInput" value="24" style="width:66px; margin-left:6px" /></label>
  </div>
  <div id="status">Загрузка...</div>
  <div id="grid" class="grid" aria-live="polite"></div>

  <script type="module">
    import './js/api.client.js';
    import MangadexService from './js/mangadex.service.js';

  const grid = document.getElementById('grid');
  const status = document.getElementById('status');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const pageDisplay = document.getElementById('pageDisplay');
  const limitInput = document.getElementById('limitInput');

  let currentPage = 1;
  let currentLimit = parseInt(limitInput.value, 10) || 24;
  let totalPages = 1;

    function firstLang(obj) {
      if (!obj) return null;
      if (typeof obj === 'string') return obj;
      const keys = Object.keys(obj);
      for (const k of ['en','en-us','en-gb']) if (obj[k]) return obj[k];
      return obj[keys[0]];
    }

    function truncate(s, n=260) { if (!s) return ''; return s.length>n ? s.slice(0,n).trim() + '...' : s; }

    async function renderList(items) {
      grid.innerHTML = '';
      const coverPromises = [];

      for (const item of items) {
        const id = item.id;
        const a = item.attributes || {};
        const title = firstLang(a.title) || '(No title)';
        const alt = (a.altTitles && a.altTitles.length) ? firstLang(a.altTitles[0]) : '';
        const desc = firstLang(a.description) || '';
        const tags = (a.tags||[]).map(t => (t?.attributes?.name && firstLang(t.attributes.name)) || '').filter(Boolean);

        const card = document.createElement('article');
        card.className = 'card';

        const img = document.createElement('img');
        img.className = 'thumb';
        img.alt = title;
        img.src = '/css/placeholder.png';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <div class="title">${escapeHtml(title)}</div>
          <div class="subtitle">${escapeHtml(alt)}</div>
          <div class="desc">${escapeHtml(truncate(desc, 300))}</div>
        `;

        const tagsWrap = document.createElement('div');
        tagsWrap.className = 'tags';
        for (const t of tags) { const el=document.createElement('div'); el.className='tag'; el.textContent=t; tagsWrap.appendChild(el); }
        meta.appendChild(tagsWrap);

        card.appendChild(img);
        card.appendChild(meta);
        grid.appendChild(card);

        // Find cover_art relationship id
        const rel = (item.relationships || []).find(r => r.type === 'cover_art');
        if (rel && rel.id) {
          // fetch cover info then set src
          const p = MangadexService.callProxy(`/cover/${rel.id}`)
            .then(res => {
              const data = res?.data || res;
              const fileName = data?.attributes?.fileName;
              if (fileName) {
                img.src = `https://uploads.mangadex.org/covers/${id}/${fileName}`;
              }
            }).catch(()=>{});
          coverPromises.push(p);
        }
      }

      await Promise.allSettled(coverPromises);
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    async function load(page = 1) {
      try {
        currentLimit = parseInt(limitInput.value, 10) || 24;
        status.textContent = 'Загрузка списка...';
        const res = await MangadexService.getNewReleases(page, currentLimit);
        const items = res?.data || [];
        const total = res?.total || items.length || 0;
        totalPages = Math.max(1, Math.ceil(total / currentLimit));
        currentPage = page;
        pageDisplay.textContent = String(currentPage);
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        if (!items.length) status.textContent = 'Нет результатов'; else status.textContent = `Показаны ${items.length} из ${total}`;
        await renderList(items);
      } catch (err) {
        status.textContent = 'Ошибка: ' + (err.message || err);
        grid.innerHTML = '<pre>'+escapeHtml(String(err))+'</pre>';
      }
    }

    prevBtn.addEventListener('click', () => { if (currentPage>1) load(currentPage-1); });
    nextBtn.addEventListener('click', () => { if (currentPage<totalPages) load(currentPage+1); });
    limitInput.addEventListener('change', () => { load(1); });

    // initial load
    load(1);
  </script>
</body>
</html>
