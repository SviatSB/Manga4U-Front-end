const l="https://manga4u-164617ec4bac.herokuapp.com",r={localKey:"m4u_token",sessionKey:"m4u_token_session",get(){return localStorage.getItem(this.localKey)||sessionStorage.getItem(this.sessionKey)||null},set(e,t=!1){t?localStorage.setItem(this.localKey,e):sessionStorage.setItem(this.sessionKey,e)},clear(){localStorage.removeItem(this.localKey),sessionStorage.removeItem(this.sessionKey)}};async function h(e,t={}){const a=r.get(),i=new Headers(t.headers||{});t.body&&!(t.body instanceof FormData)&&i.set("Content-Type","application/json"),a&&i.set("Authorization",`Bearer ${a}`);const s=await fetch(`${l}${e}`,{...t,headers:i});let n=await s.text(),o;try{o=n?JSON.parse(n):null}catch{o=n}if(!s.ok){const c=new Error(o?.message||o||s.statusText);throw c.status=s.status,c.status===401&&r.clear(),c}return o}window.apiFetch=h;window.Auth={async login(e,t,a=!1){const i=await fetch(`${l}/api/Account/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({login:e,password:t})}),s=await i.text();let n;try{n=s?JSON.parse(s):null}catch{n=s}if(!i.ok)throw new Error(n?.message||"Login failed");const o=n?.token;if(!o)throw new Error("Server did not return token");return r.set(o,a),o},async me(e=!1){if(!r.get()){if(e)throw new Error("No token");return null}try{return await h("/api/Account/me")}catch(a){if(a.status===401&&r.clear(),e)throw a;return null}},logout(){r.clear(),location.href="./auth.html"}};window.TokenStore=r;
