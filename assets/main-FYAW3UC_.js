const E="https://manga4u-164617ec4bac.herokuapp.com";function $(t={}){const e=[];for(const a of Object.keys(t)){const n=t[a];if(n!=null)if(Array.isArray(n))for(const o of n)e.push(`${encodeURIComponent(a)}=${encodeURIComponent(o)}`);else e.push(`${encodeURIComponent(a)}=${encodeURIComponent(n)}`)}return e.join("&")}async function h(t,e={},a={}){const n="/api/mangadexproxy",o={path:t};Object.assign(o,e);const i=$(o),s=`${n}?${i}`;if(typeof window<"u"&&window.apiFetch)return window.apiFetch(s,a);const r=new Headers(a.headers||{}),c=await fetch(`${E}${s}`,{...a,headers:r}),u=await c.text();let f;try{f=u?JSON.parse(u):null}catch{f=u}if(!c.ok){const m=new Error(f?.message||f||c.statusText);throw m.status=c.status,m}return f}let l=null;function g(t){return String(t||"").toLowerCase().replace(/["'’`]/g,"").replace(/\s+/g," ").trim()}async function w(){if(l)return l;l={byName:new Map};try{const e=(await h("/manga/tag"))?.data||[];l.tags=e;for(const a of e){const n=a.id,o=a.attributes?.name||{};for(const s of Object.keys(o)){const r=o[s];if(!r)continue;const c=g(r);c&&l.byName.set(c,n)}const i=o.en;i&&l.byName.set(g(i),n),a.attributes?.name&&typeof a.attributes.name=="string"&&l.byName.set(g(a.attributes.name),n)}}catch(t){console.warn("Could not fetch tag list from Mangadex proxy:",t)}return l}async function A(t=[]){if(!t||!t.length)return[];const e=o=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(o),a=await w(),n=[];for(const o of t){if(!o)continue;if(e(o)){n.push(o);continue}const i=g(o);let s=a?.byName.get(i);if(!s){for(const[r,c]of(a?.byName||new Map).entries())if(r.includes(i)||i.includes(r)){s=c;break}}s?n.push(s):console.warn("Tag not resolved to id:",o)}return n}async function C({title:t="",genres:e=[],page:a=1,limit:n=20}={}){const o=(Math.max(1,a)-1)*n,i={title:t||void 0,limit:n,offset:o};if(Array.isArray(e)&&e.length){const s=await A(e);s.length?i["includedTags[]"]=s:i["includedTags[]"]=e}return h("/manga",i,{method:"GET"})}async function I(t=1,e=20){const a=(Math.max(1,t)-1)*e;return h("/manga",{limit:e,offset:a,"order[createdAt]":"desc"},{method:"GET"})}async function M(t=1,e=20){const a=(Math.max(1,t)-1)*e;return h("/manga",{limit:e,offset:a,"order[followedCount]":"desc"},{method:"GET"})}async function N(){return l=null,w()}const b={search:C,getNewReleases:I,getPopular:M,callProxy:h,resolveTagIds:A,refreshTagCache:N,_ensureTagCache:w};typeof window<"u"&&(window.MangadexService=b);const _="https://manga4u-164617ec4bac.herokuapp.com",y={key:"m4u_token",skey:"m4u_token_session",get(){return localStorage.getItem(this.key)||sessionStorage.getItem(this.skey)||null},set(t,e){e?localStorage.setItem(this.key,t):sessionStorage.setItem(this.skey,t)},clear(){localStorage.removeItem(this.key),sessionStorage.removeItem(this.skey)}};async function v(t,e={}){const a=y.get(),n=new Headers(e.headers||{});e.body&&!(e.body instanceof FormData)&&n.set("Content-Type","application/json"),a&&n.set("Authorization",`Bearer ${a}`);const o=await fetch(`${_}${t}`,{...e,headers:n});let i=await o.text(),s;try{s=i?JSON.parse(i):null}catch{s=i}if(!o.ok){o.status===401&&y.clear();const r=new Error(s?.message||o.statusText);throw r.status=o.status,r}return s}window.apiFetch=v;const d=(t,e=document)=>e.querySelector(t),S=(t,e=document)=>Array.from(e.querySelectorAll(t));async function F(){const t=document.getElementById("genresGrid");if(t)try{const e=await v("/api/history");if(!Array.isArray(e)||e.length===0){t.innerHTML='<p style="opacity:.7;">Немає історії</p>';return}const a=e.sort((n,o)=>new Date(o.updatedAt)-new Date(n.updatedAt)).slice(0,8);t.innerHTML="";for(const n of a){const o=n.lastChapterId||n.LastChapterId||n.chapterId,i=n.mangaName||n.MangaName||"Невідома манґа",s=n.lastChapterNumber??n.LastChapterNumber??"?",r=n.lastChapterTitle||n.LastChapterTitle||"Без назви",c=document.createElement("div");c.className="genre-card panel__item",c.innerHTML=`
        <div class="history-title">${i}</div>
        <div class="history-subtitle">Розділ ${s}</div>
        <div class="history-small">${r}</div>
      `,c.onclick=()=>{location.href=`/reader.html?chapterId=${o}`},t.appendChild(c)}}catch(e){console.error("Помилка завантаження історії на головній:",e)}}async function B(){if(!y.get())return null;try{return await v("/api/Account/me")}catch{return null}}function H(t){S(".guard-required").forEach(e=>{e.classList.toggle("is-disabled",t),t?(e.dataset.href=e.getAttribute("href"),e.setAttribute("href","#"),e.addEventListener("click",T)):(e.dataset.href&&e.setAttribute("href",e.dataset.href),e.removeEventListener("click",T))})}function T(t){t.preventDefault();const e=t.currentTarget,a=document.createElement("span");a.className="guard-tip",a.textContent="Доступно після входу",e.appendChild(a),setTimeout(()=>a.remove(),1500),setTimeout(()=>{location.href="./auth.html?next=./index.html"},500)}function R(){const t=d("#profileBtn"),e=d("#profileMenu");if(!t||!e)return;function a(){e.hidden=!1,t.setAttribute("aria-expanded","true"),document.addEventListener("pointerdown",i),document.addEventListener("keydown",s)}function n(){e.hidden=!0,t.setAttribute("aria-expanded","false"),document.removeEventListener("pointerdown",i),document.removeEventListener("keydown",s)}function o(){e.hidden?a():n()}function i(r){!e.contains(r.target)&&!t.contains(r.target)&&n()}function s(r){r.key==="Escape"&&n()}t.addEventListener("click",o),d("#logoutBtn")?.addEventListener("click",()=>{y.clear(),location.reload()})}function G(){const t=document.body,e=d(".burger"),a=d("#mobileMenu"),n=d(".mobileMenu__backdrop");if(!e||!a||!n)return;function o(){e.classList.add("is-active"),a.classList.add("is-open"),t.classList.add("menu-open"),n.hidden=!1,requestAnimationFrame(()=>n.classList.add("is-open"))}function i(){e.classList.remove("is-active"),a.classList.remove("is-open"),t.classList.remove("menu-open"),n.classList.remove("is-open"),setTimeout(()=>n.hidden=!0,280)}e.addEventListener("click",()=>{a.classList.contains("is-open")?i():o()}),n.addEventListener("click",i),window.addEventListener("keydown",s=>{s.key==="Escape"&&i()})}async function P(){const t=document.getElementById("frontRecoGrid");if(t){t.innerHTML="";try{const e=await v("/api/history/recomendation-vector?limit=20"),a=Array.isArray(e)?e:e?.items||[];if(!a.length){t.innerHTML='<div style="padding:12px;opacity:.6">Немає рекомендацій</div>';return}const o={"includedTags[]":a.filter(r=>r.genreId).sort((r,c)=>c.number-r.number).slice(0,2).map(r=>r.genreId),includedTagsMode:"OR","contentRating[]":["safe","suggestive"],limit:10,"order[relevance]":"desc"},s=(await b.callProxy("/manga",o,{method:"GET"}))?.data||[];if(!s.length){t.innerHTML='<div style="padding:12px;opacity:.6">Не знайдено манґ</div>';return}for(const r of s){const c=r.id,u=r.attributes||{},f=u.title?.uk||u.title?.en||Object.values(u.title||{})[0]||"Без назви";let m="/css/placeholder.png";const L=(r.relationships||[]).find(k=>k.type==="cover_art");if(L?.id)try{const x=(await b.callProxy(`/cover/${L.id}`))?.data?.attributes?.fileName;x&&(m=`https://uploads.mangadex.org/covers/${c}/${x}`)}catch{}const p=document.createElement("a");p.href=`/manga.html?id=${c}`,p.className="card",p.innerHTML=`
        <div class="card__stub" style="background-image:url('${m}')"></div>
        <div class="card__title">${f}</div>
      `,t.appendChild(p)}}catch(e){console.error("Front recommendations error:",e),t.innerHTML='<div style="padding:12px;opacity:.6">Помилка завантаження</div>'}}}(async function(){G(),R();const e=await B(),a=!e,n=d("#loginLink"),o=d("#profileBlock"),i=d("#mobileLoginLink"),s=d("#mobileLogoutBtn"),r=d("#mobileProfileLink");a?(n&&(n.hidden=!1),i&&(i.hidden=!1),o&&(o.hidden=!0),r&&(r.hidden=!0),s&&(s.hidden=!0)):(n?.remove(),i?.remove(),o&&(o.hidden=!1),r&&(r.hidden=!1),s&&(s.hidden=!1),d("#profileName").textContent=e.nickname||e.userName||e.email||"Кабінет"),H(a),a||(F(),P())})();export{b as M};
