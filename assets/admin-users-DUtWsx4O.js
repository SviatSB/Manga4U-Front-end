import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css             */import"./api.client-Cwoejsn1.js";import"./header.init-DNZ4xaCr.js";window.UsersStore=function(){async function L(i={}){const u=new URLSearchParams;if(i.skip&&u.set("skip",i.skip),i.take&&u.set("take",i.take),i.nickname&&u.set("nickname",i.nickname),i.login&&u.set("login",i.login),i.roles&&i.roles.length)for(const k of i.roles)u.append("roles",k);const g=await apiFetch(`/api/Admin/users?${u.toString()}`,{method:"GET"}),h=g?.items||[],v=g?.total??h.length;return{items:h,total:v}}async function r(i){const{items:u}=await L();return u.find(g=>g.id===i)||null}return{fetchAll:L,getById:r}}();(function(L,r){var i=r.querySelector("#modal"),u=r.querySelector("#modalText"),g=r.querySelector("#modalOk"),h=r.querySelector("#modalCancel"),v=r.querySelector("#toasts");v||(v=r.createElement("div"),v.id="toasts",v.className="toasts",r.body.appendChild(v));function k(l,e){var d=r.createElement("div");d.className="toast "+(e==="err"?"toast--err":"toast--ok"),d.textContent=l,v.appendChild(d),setTimeout(function(){d.remove()},2600)}function w(l){return!i||!u||!g||!h?Promise.resolve(window.confirm(l)):new Promise(function(e){u.textContent=l,i.hidden=!1;function d(b){b.preventDefault(),C(),e(!0)}function $(b){b&&b.preventDefault(),C(),e(!1)}function x(b){b.key==="Escape"&&$(b)}function E(b){b.target===i&&$(b)}function C(){i.hidden=!0,g.removeEventListener("click",d),h.removeEventListener("click",$),window.removeEventListener("keydown",x),i.removeEventListener("click",E)}g.addEventListener("click",d),h.addEventListener("click",$),window.addEventListener("keydown",x),i.addEventListener("click",E),setTimeout(function(){g.focus()},0)})}L.Confirm={ask:w},L.Toast={ok:l=>k(l,"ok"),err:l=>k(l,"err")}})(window,document);(function(L,r){document.addEventListener("DOMContentLoaded",()=>{const i="https://manga4u-164617ec4bac.herokuapp.com",u=r.querySelector("#q"),g=r.querySelector("#roleSel"),h=r.querySelector("#statusSel"),v=r.querySelector("#usersBody"),k=r.querySelector("#pager"),w=r.querySelector("#usersCard"),l=r.querySelector("#adminAlert"),e={page:1,perPage:10,q:"",role:"",status:""};let d=null,$=!1,x=!1,E=[];C().catch(t=>{console.error(t),y(t.message||"Помилка ініціалізації","err")});async function C(){try{d=await Auth.me(!0)}catch{w?.setAttribute("hidden","true"),l&&(l.hidden=!1,l.textContent="Потрібна авторизація.");return}if($=Auth.hasRole(d,"owner"),x=$||Auth.hasRole(d,"admin"),!x){w.hidden=!0,l.hidden=!1,l.textContent="У вас немає прав доступу.";return}l.hidden=!0,w.hidden=!1,u?.addEventListener("input",O(()=>{e.q=u.value.trim(),e.page=1,S()},250)),g?.addEventListener("change",()=>{e.role=g.value,e.page=1,S()}),h?.addEventListener("change",()=>{e.status=h.value,e.page=1,S()}),await S()}async function b(){const t=(e.page-1)*e.perPage,s=e.perPage,n=new URLSearchParams;n.set("skip",t),n.set("take",s),e.q&&(n.set("nickname",e.q),n.set("login",e.q)),e.role&&n.append("roles",e.role);const o=await apiFetch(`/api/Admin/users?${n.toString()}`,{method:"GET"}),f=o?.items||[],q=o?.total??f.length;return E=f,{items:f,total:q}}async function S(){try{const{items:t,total:s}=await b(),n=e.status?t.filter(f=>T(f)===e.status):t;v.innerHTML="",n.forEach(f=>v.appendChild(m(f)));const o=Math.max(1,Math.ceil(s/e.perPage));k.innerHTML="",k.append(I("«",e.page<=1,()=>{e.page>1&&(e.page--,S())}),U(`${e.page}/${o}`),I("»",e.page>=o,()=>{e.page<o&&(e.page++,S())}))}catch(t){console.error(t),y(t.message||"Помилка завантаження користувачів","err")}}function y(t,s="ok"){const n=document.createElement("div");n.className=`msg ${s==="err"?"msg--err":"msg--ok"}`,n.textContent=t,n.style.position="fixed",n.style.bottom="20px",n.style.left="50%",n.style.transform="translateX(-50%)",n.style.padding="8px 16px",n.style.borderRadius="8px",n.style.background=s==="err"?"#a33":"#3a3",n.style.color="#fff",n.style.zIndex=9999,document.body.appendChild(n),setTimeout(()=>n.remove(),2500)}function T(t){const s=!!(t.isBanned??t.banned??t.status==="banned"),n=!!(t.isMuted??t.muted??t.status==="muted");return s?"banned":n?"muted":"active"}function a(t){return(t.roles||[]).map(n=>String(n).toLowerCase()).includes("admin")}function c(t){return(t.roles||[]).map(n=>String(n).toLowerCase()).includes("owner")}function m(t){const s=r.createElement("div");s.className="userRow";const n=T(t),o=a(t),f=c(t),q=typeof t.avatarUrl=="string"&&t.avatarUrl.trim()?t.avatarUrl.trim():"";return s.innerHTML=`
        <div class="col col--nick">
          <img class="userAvatar" src="${M(q)}" alt="avatar">
          <div>
            <div class="userNick">${M(t.nickname||t.userName)}</div>
            <div class="userEmail">${M(t.login||t.email)}</div>
          </div>
        </div>
        <div class="col col--email">${M(t.email||t.login)}</div>
        <div class="col col--role"><span class="badge ${f?"badge--role-owner":o?"badge--role-admin":""}">
          ${f?"Власник":o?"Адмін":"Користувач"}</span></div>
        <div class="col col--status"><span class="badge ${R(n)}">${N(n)}</span></div>
        <div class="col col--actions">
          <div class="actionBar">
            ${$?o&&!f?`<button class="ghostBtn act" data-act="demote" data-id="${t.id}">Зняти адміна</button>`:f?"":`<button class="btn btn--primary act" data-act="promote" data-id="${t.id}">Видати адміна</button>`:""}

            ${n!=="banned"?`<button class="ghostBtn act" data-act="${n==="muted"?"unmute":"mute"}" data-id="${t.id}">${n==="muted"?"Зняти м'ют":"М'ют"}</button>`:""}

            ${n==="banned"?`<button class="ghostBtn act" data-act="unban" data-id="${t.id}">Розбан</button>`:`<button class="ghostBtn act" data-act="ban" data-id="${t.id}">Бан</button>`}
          </div>
        </div>`,s.addEventListener("click",p),s}function p(t){const s=t.target.closest(".act");s&&B(Number(s.dataset.id),s.dataset.act)}async function B(t,s){try{const n=localStorage.getItem("m4u_token")||sessionStorage.getItem("m4u_token"),o=E.find(P=>P.id===t);if(!o)return;const f=T(o);if(c(o)){y("⚠️ Неможливо виконати дію над власником системи","err");return}if(a(o)&&!$){y("⚠️ Ви не можете виконати дію над іншим адміністратором","err");return}if(f==="banned"&&s==="mute"){y("⚠️ Користувач вже забанений (м’ют не потрібен)","err");return}const q=await fetch(`${i}/api/Admin/user/${t}/${s}`,{method:"POST",headers:{Authorization:`Bearer ${n}`}});if(!q.ok){const P=await q.text();throw new Error(P||q.statusText)}switch(s){case"ban":o.isBanned=!0,o.isMuted=!0;break;case"unban":o.isBanned=!1,o.isMuted=!1;break;case"mute":o.isMuted=!0,o.muted=!0;break;case"unmute":o.isMuted=!1,o.muted=!1,localStorage.setItem(`m4u_unmuted_${t}`,"true");break}A(t,T(o)),y(`Операцію "${s}" виконано ✅`)}catch(n){console.error("❌ handleAction error:",n),y(n.message||"Помилка при виконанні дії","err")}}function A(t,s){const n=v.querySelector(`[data-id="${t}"]`)?.closest(".userRow");if(!n){S();return}const o=n.querySelector(".col--status span");o&&(o.className=`badge ${R(s)}`,o.textContent=N(s));const f=n.querySelector(".actionBar");f&&(E.find(q=>q.id===t),f.innerHTML=`
        ${s!=="banned"?`<button class="ghostBtn act" data-act="${s==="muted"?"unmute":"mute"}" data-id="${t}">${s==="muted"?"Зняти м'ют":"М'ют"}</button>`:""}

        ${s==="banned"?`<button class="ghostBtn act" data-act="unban" data-id="${t}">Розбан</button>`:`<button class="ghostBtn act" data-act="ban" data-id="${t}">Бан</button>`}
      `)}function I(t,s,n){const o=r.createElement("button");return o.textContent=t,o.disabled=!!s,o.addEventListener("click",n),o}function U(t){const s=r.createElement("span");return s.style.padding="8px 12px",s.textContent=t,s}function N(t){return t==="active"?"Активний":t==="muted"?"Замучений":"Забанений"}function R(t){return t==="active"?"badge--status-active":t==="muted"?"badge--status-muted":"badge--status-banned"}function M(t){return String(t||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[s])}function O(t,s){let n=null;return(...o)=>{clearTimeout(n),n=setTimeout(()=>t(...o),s)}}})})(window,document);(function(L,r){const i=L.currentUser||{role:"user"},u=r.querySelector("#q"),g=r.querySelector("#roleSel"),h=r.querySelector("#statusSel"),v=r.querySelector("#usersBody"),k=r.querySelector("#pager"),w=r.querySelector("#usersCard"),l=r.querySelector("#adminAlert");if(["admin","owner"].includes(i.role?.toLowerCase()))l&&(l.hidden=!0),w&&(w.hidden=!1);else{w&&(w.hidden=!0),l&&(l.hidden=!1,l.textContent="У вас немає прав доступу.");return}const e={page:1,perPage:10,q:"",role:"",status:""};u&&u.addEventListener("input",T(()=>{e.q=u.value.trim(),e.page=1,d()},250)),g&&g.addEventListener("change",()=>{e.role=g.value,e.page=1,d()}),h&&h.addEventListener("change",()=>{e.status=h.value,e.page=1,d()});async function d(){try{const{items:a,total:c}=await UsersStore.fetchAll({skip:(e.page-1)*e.perPage,take:e.perPage,nickname:e.q,login:e.q,roles:e.role?[e.role]:[]}),m=e.status?a.filter(B=>(B.status||"active")===e.status):a;v.innerHTML="",m.forEach(B=>v.appendChild($(B)));const p=Math.max(1,Math.ceil(c/e.perPage));k.innerHTML="",k.append(E("«",e.page<=1,()=>{e.page>1&&(e.page--,d())}),C(`${e.page}/${p}`),E("»",e.page>=p,()=>{e.page<p&&(e.page++,d())}))}catch(a){console.error(a),Toast?.err(a.message||"Помилка завантаження користувачів")}}function $(a){const c=r.createElement("div");c.className="userRow";const m=a.status||"active",p=(a.roles||[a.role||"user"])[0]?.toLowerCase()||"user";return c.innerHTML=`
      <div class="col col--nick">
        <img class="userAvatar" src="${y(a.avatarUrl||"./img/avatar-placeholder.png")}" alt="">
        <div>
          <div class="userNick">${y(a.nickname||a.userName||a.email)}</div>
          <div class="userEmail">${y(a.email||a.login)}</div>
        </div>
      </div>
      <div class="col col--email">${y(a.email||a.login)}</div>
      <div class="col col--role"><span class="badge ${p==="admin"?"badge--role-admin":""}">${p==="admin"?"Адмін":"Користувач"}</span></div>
      <div class="col col--status"><span class="badge ${S(m)}">${b(m)}</span></div>
      <div class="col col--actions">
        <div class="actionBar">
          ${i.role==="owner"?p==="admin"?`<button class="ghostBtn act" data-act="demote" data-id="${a.id}">Зняти адміна</button>`:`<button class="btn btn--primary act" data-act="promote" data-id="${a.id}">Видати адміна</button>`:""}
          ${m==="muted"?`<button class="ghostBtn act" data-act="unmute" data-id="${a.id}">Зняти м'ют</button>`:`<button class="ghostBtn act" data-act="mute" data-id="${a.id}">М'ют</button>`}
          ${m==="banned"?`<button class="ghostBtn act" data-act="unban" data-id="${a.id}">Розбан</button>`:`<button class="ghostBtn act" data-act="ban" data-id="${a.id}">Бан</button>`}
        </div>
      </div>`,c.addEventListener("click",B=>{const A=B.target.closest(".act");A&&x(A.dataset.act,Number(A.dataset.id))}),c}async function x(a,c){try{const m=await apiFetch(`/api/Admin/user/${c}/${a}`,{method:"POST"});Toast?.ok(`Операцію "${a}" виконано ✅`),d()}catch(m){console.error("❌ handleAction error:",m),Toast?.err(m.message||"Помилка при виконанні дії")}}function E(a,c,m){const p=r.createElement("button");return p.textContent=a,p.disabled=!!c,p.addEventListener("click",m),p}function C(a){const c=r.createElement("span");return c.style.padding="8px 12px",c.style.opacity=".8",c.textContent=a,c}function b(a){return a==="active"?"Активний":a==="muted"?"Замучений":"Забанений"}function S(a){return a==="active"?"badge--status-active":a==="muted"?"badge--status-muted":"badge--status-banned"}function y(a){return String(a||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[c])}function T(a,c){let m=null;return(...p)=>{clearTimeout(m),m=setTimeout(()=>a(...p),c)}}d()})(window,document);
