document.addEventListener("DOMContentLoaded",async()=>{const v="https://manga4u-164617ec4bac.herokuapp.com",r=document.getElementById("profileBtn"),i=document.getElementById("profileMenu"),u=document.getElementById("logoutBtn"),f=document.getElementById("loginLink"),l=document.getElementById("profileBlock"),g=document.getElementById("profileName"),d=document.getElementById("roleBadge"),c=document.querySelector(".burger"),a=document.getElementById("mobileMenu"),h=()=>document.getElementById("mobileLoginLink"),L=()=>document.getElementById("mobileProfileLink"),k=()=>document.getElementById("mobileLogoutBtn"),B=localStorage.getItem("m4u_token")||sessionStorage.getItem("m4u_token");if(!B){m();return}try{const e=await fetch(`${v}/api/Account/me`,{headers:{Authorization:`Bearer ${B}`}});if(!e.ok)throw new Error("Unauthorized");const n=await e.json();if(!n||!n.nickname){m();return}g&&(g.textContent=n.nickname),l&&(l.hidden=!1),p();const o=(n.roles||[]).map(t=>t.toLowerCase());if(o.includes("admin")||o.includes("owner")){d&&(d.hidden=!1,d.textContent=o.includes("owner")?"Owner":"Admin");const t=document.querySelector(".profile__item--admin"),I=document.querySelector(".mobileMenu__link--admin");t&&(t.hidden=!1),I&&(I.hidden=!1)}else d&&(d.hidden=!0);const y=h(),b=L(),s=k();y&&(y.hidden=!0),b&&(b.hidden=!1),s&&(s.hidden=!1),r&&i&&(r.addEventListener("click",t=>{t.stopPropagation(),i.hidden=!i.hidden,r.classList.toggle("active")}),document.addEventListener("click",t=>{!i.hidden&&!t.target.closest("#profileMenu")&&!t.target.closest("#profileBtn")&&(i.hidden=!0,r.classList.remove("active"))})),u&&u.addEventListener("click",E),s&&s.addEventListener("click",E),setTimeout(p,500)}catch(e){console.error("Header init error:",e),m()}c&&a&&c.addEventListener("click",()=>{const e=c.getAttribute("aria-expanded")==="true";c.setAttribute("aria-expanded",!e),a.classList.toggle("open",!e),a.setAttribute("aria-hidden",e)});function p(){document.querySelectorAll('#loginLink, #mobileLoginLink, a[href*="auth"]').forEach(e=>{e.hidden=!0,e.style.display="none"})}function m(){f&&(f.hidden=!1),l&&(l.hidden=!0);const e=h(),n=L(),o=k();e&&(e.hidden=!1),n&&(n.hidden=!0),o&&(o.hidden=!0)}function E(){localStorage.removeItem("m4u_token"),sessionStorage.removeItem("m4u_token"),localStorage.removeItem("m4u_login"),window.location.href="../auth.html"}});
